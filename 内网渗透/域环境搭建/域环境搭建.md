# 之前的问题

- 08 作为主域控，操作不是很舒服，略卡顿
- 避免一个虚拟机重复拷贝，可能会出现加用户时，提示 SID 冲突
- 账号密码未设置为永不失效，需要频繁修改密码
- 只有一个域用户，所有机器均是它加进域的，测试委派时易混乱
- AD CS 部署问题
- 网段划分
- 同网段内，域外机器，方便测试，包括 Kali 等机器
- VM 仅主机模式，不出网问题

# 规划图

![image-20221113235528131](./域环境搭建.assets/image-20221113235528131.png)



# 双网卡

双网卡机器上，server16、server12 在访问 test.com 会走域内的 dns，win7 就直接访问了公网，更改 DNS 设置也不行

暂时考虑日常将 NAT 网卡禁用，需要联网下载时，再启用

# ADCS

![image-20221113150414746](./域环境搭建.assets/image-20221113150414746.png)

![image-20221113150621146](./域环境搭建.assets/image-20221113150621146.png)

![image-20221113150557916](./域环境搭建.assets/image-20221113150557916.png)

先配置证书颁发机构，需要依赖前两个服务

![image-20221113150941624](./域环境搭建.assets/image-20221113150941624.png)

![image-20221113151032792](./域环境搭建.assets/image-20221113151032792.png)

结束后再配置其他角色服务

![image-20221113151112088](./域环境搭建.assets/image-20221113151112088.png)

![image-20221113151146092](./域环境搭建.assets/image-20221113151146092.png)

需要指定一个域用户，并且在本地的 IIS_IUSRS 组当中 ，如果 ADCS 安装在域控上，那么这个用户也需要能够登录域控（可以选择将其加入管理员组，当然是有风险的）

![image-20221113151215211](./域环境搭建.assets/image-20221113151215211.png)

将用户添加到域管组当中

![image-20221113151954017](./域环境搭建.assets/image-20221113151954017.png)

指定时需要输入密码

![image-20221113152046084](./域环境搭建.assets/image-20221113152046084.png)

后面也有同样的需求，操作一致

![image-20221113152206162](./域环境搭建.assets/image-20221113152206162.png)

之后就完成了整个的安装

访问 `http://192.168.20.10/certsrv/` 

需要使用域用户来认证

![image-20221113153149213](./域环境搭建.assets/image-20221113153149213.png)

![image-20221113153312315](./域环境搭建.assets/image-20221113153312315.png)

然后申请证书-》高级证书

![image-20221113153336300](./域环境搭建.assets/image-20221113153336300.png)

这里需要提交 Base64 的证书提交

![image-20221113153422235](./域环境搭建.assets/image-20221113153422235.png)

在 IIS 中进入服务器证书，选择创建

![image-20221113153029439](./域环境搭建.assets/image-20221113153029439.png)

通用名称就是需要申请的域名

![image-20221113153621487](./域环境搭建.assets/image-20221113153621487.png)

之后会生成一个 Base64 的证书文件

![image-20221113153730018](./域环境搭建.assets/image-20221113153730018.png)

![image-20221113153752413](./域环境搭建.assets/image-20221113153752413.png)

将值贴入，并选择证书模板为 Web 服务器

![image-20221113153824974](./域环境搭建.assets/image-20221113153824974.png)

之后下载证书，会得到一个 cer 的证书文件

![image-20221113153917711](./域环境搭建.assets/image-20221113153917711.png)

接着在  IIS 中选择完成创建

![image-20221113153958572](./域环境搭建.assets/image-20221113153958572.png)

选择并指定存储

![image-20221113154035608](./域环境搭建.assets/image-20221113154035608.png)

接下来验证一下，是否生效

手动增加一条 A 记录

![image-20221113152711897](./域环境搭建.assets/image-20221113152711897.png)

直接访问 https 会出现证书错误

![image-20221113154224283](./域环境搭建.assets/image-20221113154224283.png)

然后编辑网站并修改 SSL 证书

![image-20221113154313787](./域环境搭建.assets/image-20221113154313787.png)

之后再重新访问，证书已经正常工作

![image-20221113154356770](./域环境搭建.assets/image-20221113154356770.png)

- 注意主备域控之间的数据同步是需要时间的，DNS 记录的同步默认需要 15 分钟，在同步之后还需要通过 `ipconfig /flushdns` 来刷新一下本地的 DNS 缓存才能够生效

# Exchange

在 Server16 上安装 ExchangeServer2016-x64-cu11

需要先安装一个补丁包 kb3206632

但是如果直接装载会报错

![image-20221113210342846](./域环境搭建.assets/image-20221113210342846.png)

可以在本地解压完成后，再拷入执行 Setup

![image-20221113210437065](./域环境搭建.assets/image-20221113210437065.png)

之后等待一会，时间可能会较长，之后就会出现安装界面

![image-20221113210538978](./域环境搭建.assets/image-20221113210538978.png)

之后就是复制文件，初始化等操作了，静待安装

![image-20221113210853382](./域环境搭建.assets/image-20221113210853382.png)

为了简便，选择不拆分

![image-20221113210928330](./域环境搭建.assets/image-20221113210928330.png)

在检查完先决条件后，就可以安装了

![image-20221113211015267](./域环境搭建.assets/image-20221113211015267.png)

之后就发现需要有多个环境包需要安装

![image-20221113211452784](./域环境搭建.assets/image-20221113211452784.png)

在解决完依赖之后，就可以继续安装了

![image-20221113213247180](./域环境搭建.assets/image-20221113213247180.png)

漫长等待之后就完成了

![image-20221114104237486](./域环境搭建.assets/image-20221114104237486.png)

之后在 PC 机器上验证，此时只能登录管理员，其他域用户当前是不存在邮箱账号的

![image-20221114104931907](./域环境搭建.assets/image-20221114104931907.png)

如果登录的时候，出现了 "Microsoft.Exchange.Data.Storage.ObjectNotFoundException" 的错误

![image-20221114125029659](./域环境搭建.assets/image-20221114125029659.png)

此时事件查看器中的错误是 146

![image-20221114125409591](./域环境搭建.assets/image-20221114125409591.png)

可以去 Exchange 的 Management Shell 当中执行下面的命令，先禁用用户，之后再启用

```
Disable-Mailbox -identity administrator
Enable-Mailbox -identity administrator
```

![image-20221114125224037](./域环境搭建.assets/image-20221114125224037.png)

然后再刷新就可以了

![image-20221114125443346](./域环境搭建.assets/image-20221114125443346.png)

如果访问报了 503 等错误，可以在 Exchange 的 IIS 管理当中，检查默认网站的证书绑定情况

![image-20221114125634224](./域环境搭建.assets/image-20221114125634224.png)

还有 Exchange 444、81 等端口的证书绑定情况和开放情况等

![image-20221114125820764](./域环境搭建.assets/image-20221114125820764.png)

完后重启即可



